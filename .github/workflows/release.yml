name: Build Gophish Release
on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build:
    name: Build Binary
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-22.04, macos-latest]
        arch: ['386', amd64, arm64]
        include:
          - os: windows-latest
            goos: windows
            bin: 'gophish.exe'
            releaseos: windows
          - os: ubuntu-22.04
            goos: linux
            bin: 'gophish'
            releaseos: linux
          - os: macos-latest
            goos: darwin
            bin: 'gophish'
            releaseos: osx
        exclude:
          - os: windows-latest
            arch: '386'
          - os: windows-latest
            arch: 'arm64'
          - os: macos-latest
            arch: '386'
          - os: macos-latest
            arch: 'arm64'
    steps:
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.22
      
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          if [ "${{ matrix.arch }}" == "386" ]; then
            sudo apt-get install -y gcc-multilib
          elif [ "${{ matrix.arch }}" == "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi

      - name: Set Environment Variables
        shell: bash
        run: |
          if [ "${{ matrix.arch }}" == "386" ]; then
            echo "RELEASE=gophish-${{ github.event.release.tag_name || 'manual' }}-${{ matrix.releaseos }}-32bit" >> $GITHUB_ENV
          elif [ "${{ matrix.arch }}" == "amd64" ]; then
            echo "RELEASE=gophish-${{ github.event.release.tag_name || 'manual' }}-${{ matrix.releaseos }}-64bit" >> $GITHUB_ENV
          elif [ "${{ matrix.arch }}" == "arm64" ]; then
            echo "RELEASE=gophish-${{ github.event.release.tag_name || 'manual' }}-${{ matrix.releaseos }}-arm64" >> $GITHUB_ENV
          fi
          
          # Set CC for Linux ARM64 Cross Compilation
          if [ "${{ matrix.goos }}" == "linux" ] && [ "${{ matrix.arch }}" == "arm64" ]; then
            echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          fi

      - uses: actions/checkout@v4

      - name: Build ${{ matrix.goos }}/${{ matrix.arch }}
        run: go build -o ${{ matrix.bin }}
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 1

      - name: Upload to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RELEASE }}
          path: ${{ matrix.bin }}

  package:
    name: Package Assets
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: bin
      - name: Package Releases
        run: |
          mkdir releases;
          # In v4, artifacts are downloaded into subdirectories named after the artifact
          for RELEASE_DIR in bin/*
          do
            echo "Creating release $RELEASE_DIR"
            # Extract release name from directory path
            RELEASE_NAME=$(basename $RELEASE_DIR)
            
            # The binary is inside the directory
            for BINARY in $RELEASE_DIR/*
            do
              cp $BINARY .;
              zip -r releases/$RELEASE_NAME.zip \
                $(basename ${BINARY}) \
                static/js/dist \
                static/js/src/vendor/ckeditor \
                static/css/dist \
                static/images \
                static/font \
                static/db \
                db \
                templates \
                README.md \
                README_EN.md \
                README_JA.md \
                VERSION \
                LICENSE \
                config.json;
              rm $BINARY;
            done
          done
      - name: Upload to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: releases
          path: releases/*.zip
    
  upload:
    name: Upload to the Release
    runs-on: ubuntu-latest
    needs: package
    if: github.event_name == 'release'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: releases
          path: releases/
      - name: Upload Archives to Release
        env:
          UPLOAD_URL: ${{ github.event.release.upload_url }}
          API_HEADER: "Accept: application/vnd.github.v3+json"
          AUTH_HEADER: "Authorization: token ${{ secrets.GITHUB_TOKEN }}"
        run: |
          UPLOAD_URL=$(echo -n $UPLOAD_URL | sed s/\{.*//g)
          for FILE in releases/*
          do
            echo "Uploading ${FILE}";
            curl \
              -H "${API_HEADER}" \
              -H "${AUTH_HEADER}" \
              -H "Content-Type: $(file -b --mime-type ${FILE})" \
              --data-binary "@${FILE}" \
              "${UPLOAD_URL}?name=$(basename ${FILE})";
          done
      - name: Generate SHA256 Hashes
        env:
          API_HEADER: "Accept: application/vnd.github.v3+json"
          AUTH_HEADER: "Authorization: token ${{ secrets.GITHUB_TOKEN }}"
          RELEASE_URL: ${{ github.event.release.url }}
        run: |
          HASH_TABLE="| SHA256 Hash | Filename |"
          HASH_TABLE="${HASH_TABLE}\n|-----|-----|\n"
          for FILE in releases/*
          do
            FILENAME=$(basename ${FILE})
            HASH=$(sha256sum ${FILE} | cut -d ' ' -f 1)
            HASH_TABLE="${HASH_TABLE}|${HASH}|${FILENAME}|\n"
          done
          echo "${HASH_TABLE}"
          curl \
            -XPATCH \
            -H "${API_HEADER}" \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": \"${HASH_TABLE}\"}" \
            "${RELEASE_URL}";
